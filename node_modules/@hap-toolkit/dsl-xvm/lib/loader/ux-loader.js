"use strict";var _path=_interopRequireDefault(require("path")),_loaderUtils=_interopRequireDefault(require("loader-utils")),_compilationConfig=require("@hap-toolkit/shared-utils/compilation-config"),_compiler=require("@hap-toolkit/compiler"),_validator=_interopRequireDefault(require("@hap-toolkit/compiler/lib/template/validator")),_uxFragmentUtils=require("./ux-fragment-utils"),_utils=require("./common/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const pkgInfo=require("../../package.json");function parseImportList(e,o){return Promise.all(o.map(o=>resolveImportItemSrc(e,o)))}function resolveImportItemSrc(e,o){return o.attrs.src?new Promise(t=>{e.resolve(e.context,o.attrs.src,(function(e,p){return e?(o.isValid=!1,o.err=e,t(o)):(o.isValid=!0,o.srcPath=p,t(o))}))}):(o.isValid=!1,Promise.resolve(o))}function assemble(e,o,t,p){let n="";const{enablePerformanceCheck:r}=_compilationConfig.options;if(p===_utils.ENTRY_TYPE.APP)n+=(0,_uxFragmentUtils.processStyleFrag)(e,o.style,p),n+=(0,_uxFragmentUtils.processScriptFrag)(e,o.script,p),n+=`\n$app_define$('@app-application/${t}', [], function($app_require$, $app_exports$, $app_module$){\n`,o.script.length>0&&(n+="     $app_script$($app_module$, $app_exports$, $app_require$)\n",n+="     if ($app_exports$.__esModule && $app_exports$.default) {\n            $app_module$.exports = $app_exports$.default;\n        }\n",n+="     $app_module$.exports['manifest'] = manifestJson;\n",n+="     $app_module$.exports.style = { list: [ $app_style$ ] };\n"),n+="})\n",n+=`\n$app_bootstrap$('@app-application/${t}',{ packagerVersion: '${pkgInfo.version}'})\n`;else{const a=[];r&&(n+=`\n    console.record(\`### App Performance ### 执行自定义组件模块[PERF:RPK:defineCustomCompModule(${t})]开始：${(new Date).toJSON()}\`)\n    console.time(\`PERF:RPK:defineCustomCompModule(${t})\`)\n`),r&&(n+=`\n    console.time(\`PERF:RPK:defineCustomCompImport(${t})\`)\n`),n+=(0,_uxFragmentUtils.processImportFrag)(e,o.import,a),r&&(n+=`\n    console.timeEnd(\`PERF:RPK:defineCustomCompImport(${t})\`)\n`),n+=(0,_uxFragmentUtils.processTemplateFrag)(e,o.template,p,a),n+=(0,_uxFragmentUtils.processStyleFrag)(e,o.style,p),r&&(n+=`\n    console.time(\`PERF:RPK:defineCustomCompScript(${t})\`)\n`),n+=(0,_uxFragmentUtils.processScriptFrag)(e,o.script,p),r&&(n+=`\n    console.timeEnd(\`PERF:RPK:defineCustomCompScript(${t})\`)\n`),r&&(n+=`\n    console.record(\`### App Performance ### 定义自定义组件函数[PERF:RPK:appDefineCustomCompFn(${t})]开始：${(new Date).toJSON()}\`)\n\n    console.time(\`PERF:RPK:appDefineCustomCompFn(${t})\`)\n`),n+=`\n$app_define$('@app-component/${t}', [], function($app_require$, $app_exports$, $app_module$){\n`,o.script.length>0&&(n+="     $app_script$($app_module$, $app_exports$, $app_require$)\n",n+="     if ($app_exports$.__esModule && $app_exports$.default) {\n            $app_module$.exports = $app_exports$.default\n        }\n"),n+="     $app_module$.exports.template = $app_template$\n",o.style.length>0&&(n+="     $app_module$.exports.style = $app_style$\n"),n+="})\n",r&&(n+=`\n    console.record(\`### App Performance ### 定义自定义组件函数[PERF:RPK:appDefineCustomCompFn(${t})]结束：${(new Date).toJSON()}\`)\n\n    console.timeEnd(\`PERF:RPK:appDefineCustomCompFn(${t})\`)\n`),(0,_utils.isUXRender)(p)&&(r&&(n+=`\n      console.record(\`### App Performance ### 启动页面自定义组件[PERF:RPK:appBootstrapCustomCompFn(${t})]开始：${(new Date).toJSON()}\`)\n\n      console.time(\`PERF:RPK:appBootstrapCustomCompFn(${t})\`)\n`),n+=`\n$app_bootstrap$('@app-component/${t}',{ packagerVersion: '${pkgInfo.version}'})\n`,r&&(n+=`\n      console.record(\`### App Performance ### 启动页面自定义组件[PERF:RPK:appBootstrapCustomCompFn(${t})]结束：${(new Date).toJSON()}\`)\n\n      console.timeEnd(\`PERF:RPK:appBootstrapCustomCompFn(${t})\`)\n`)),p===_utils.ENTRY_TYPE.COMP&&_compilationConfig.options.enableLazyComponent&&(r&&(n+=`\n      console.record(\`### App Performance ### 定义自定义组件封装[PERF:RPK:appDefineWrapCustomCompFn(${t})]开始：${(new Date).toJSON()}\`)\n\n      console.time(\`PERF:RPK:appDefineWrapCustomCompFn(${t})\`)\n`),n=`\n$app_define_wrap$('@app-component/${t}', function () {\n ${n} \n})\n`,r&&(n+=`\n      console.record(\`### App Performance ### 定义自定义组件封装[PERF:RPK:appDefineWrapCustomCompFn(${t})]结束：${(new Date).toJSON()}\`)\n\n      console.timeEnd(\`PERF:RPK:appDefineWrapCustomCompFn(${t})\`)\n`)),r&&(n+=`\n    console.record(\`### App Performance ### 执行自定义组件模块[PERF:RPK:defineCustomCompModule(${t})]结束：${(new Date).toJSON()}\`)\n\n    console.timeEnd(\`PERF:RPK:defineCustomCompModule(${t})\`)\n`)}return n}function loader(e){const o=this.async();this.cacheable&&this.cacheable();const t=this.resourcePath,{ext:p}=_path.default.parse(t);if(-1===[".mix",".ux"].indexOf(p))return void o(new Error(`未知文件格式：${p}`));const n=_loaderUtils.default.parseQuery(this.resourceQuery),r=n.uxType,a=n.name||(0,_utils.getNameByPath)(t);_validator.default.isReservedTag(a)&&(0,_utils.logWarn)(this,[{reason:"脚本文件名不能使用保留字:"+a}]),(0,_utils.print)({resourceQuery:this.resourceQuery,resourcePath:t,name:a});const s=(0,_compiler.parseFragmentsWithCache)(e,t);(0,_utils.print)(s),parseImportList(this,s.import).then(()=>assemble(this,s,a,r)).then(e=>{o(null,e)}).catch(e=>{o(e,"")})}module.exports=loader;
//# sourceMappingURL=ux-loader.js.map

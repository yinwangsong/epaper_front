"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.processImportFrag=processImportFrag,exports.processTemplateFrag=processTemplateFrag,exports.processStyleFrag=processStyleFrag,exports.processScriptFrag=processScriptFrag;var _path=_interopRequireDefault(require("path")),_config=_interopRequireDefault(require("@hap-toolkit/shared-utils/config")),_compilationConfig=require("@hap-toolkit/shared-utils/compilation-config"),_validator=_interopRequireDefault(require("@hap-toolkit/compiler/lib/template/validator")),_utils=require("./common/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const cwd=_config.default.projectPath,loaderPath=__dirname,defaultLoaders={component:_path.default.resolve(loaderPath,"./ux-loader.js"),fragment:_path.default.resolve(loaderPath,"./fragment-loader.js"),template:_path.default.resolve(loaderPath,"./template-loader.js"),style:_path.default.resolve(loaderPath,"./style-loader.js"),script:_path.default.resolve(loaderPath,"./script-loader.js"),module:_path.default.resolve(loaderPath,"./module-loader.js"),babel:(0,_utils.loadBabelModule)("babel-loader"),mainfest:_path.default.resolve(loaderPath,"./manifest-loader.js"),access:_path.default.resolve(loaderPath,"./access-loader.js"),json:_path.default.resolve(loaderPath,"./json-loader.js"),"extract-css":_path.default.resolve(loaderPath,"./extract-css-loader.js")},optionBabelrc=process&&process.babelrc;function makeLoaderString(e,t,a){let r;return t=t||{},e===_utils.FRAG_TYPE.IMPORT?(r=[{name:defaultLoaders.component,query:{cwd:cwd,type:_utils.FRAG_TYPE.IMPORT}}],(0,_utils.stringifyLoaders)(r)):e===_utils.FRAG_TYPE.TEMPLATE?(r=[{name:defaultLoaders.json},{name:defaultLoaders.template}],t.alone||r.push({name:defaultLoaders.fragment,query:{index:0,type:_utils.FRAG_TYPE.TEMPLATE}}),(0,_utils.stringifyLoaders)(r)):e===_utils.FRAG_TYPE.STYLE?(r=[{name:defaultLoaders.json},{name:defaultLoaders.style,query:{index:0,type:_utils.FRAG_TYPE.STYLE}}],_compilationConfig.options.enableExtractCss&&r.unshift({name:defaultLoaders["extract-css"]}),t.lang&&"css"!==t.lang&&r.push({name:`${t.lang}-loader`}),t.alone||r.push({name:defaultLoaders.fragment,query:{index:0,type:_utils.FRAG_TYPE.STYLE}}),(0,_utils.stringifyLoaders)(r)):e===_utils.FRAG_TYPE.SCRIPT?(r=[],_compilationConfig.options.enableIstanbul&&r.push({name:"istanbul-instrumenter-loader",query:{}}),r.push({name:defaultLoaders.script},{name:defaultLoaders.module}),a===_utils.ENTRY_TYPE.APP?r.push({name:defaultLoaders.mainfest,query:{path:_path.default.dirname(t.path)}},{name:defaultLoaders.babel,query:{cwd:cwd,cacheDirectory:!0,comments:!1,babelrc:optionBabelrc}}):(r.push({name:defaultLoaders.babel,query:{cwd:cwd,cacheDirectory:!0,plugins:[_path.default.resolve(loaderPath,"./babel-plugin-jsx.js")],comments:!1,babelrc:optionBabelrc}}),(0,_utils.isUXRender)(a)&&r.push({name:defaultLoaders.access})),t.alone||r.push({name:defaultLoaders.fragment,query:{index:0,type:_utils.FRAG_TYPE.SCRIPT}}),_compilationConfig.options.enableE2e&&r.push({name:require.resolve("@hap-toolkit/packager/lib/loader/inject-suite-loader.js"),query:{hookName:"onCreate"}}),(0,_utils.stringifyLoaders)(r)):void 0}function processImportFrag(e,t,a){let r="";if(t.length)for(let s=0;s<t.length;s++){const o=t[s];let l=o.attrs.src,n=o.attrs.name;if(!l)return(0,_utils.logWarn)(e,[{reason:"导入组件需要设置属性 `src` "}]),"";if(!o.isValid)return e.emitError(`导入组件resolve 出错 ${o.err}`),"";l=o.srcPath,n||(n=(0,_utils.getNameByPath)(l)),n=n.toLowerCase(),_validator.default.isReservedTag(n)&&(0,_utils.logWarn)(e,[{reason:"导入组件的属性 `name` 不能使用保留字: "+n}]),a.push(n),(0,_utils.print)({name:n,src:l});let i=(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.IMPORT),`${l}?uxType=${_utils.ENTRY_TYPE.COMP}&name=${n}`);_compilationConfig.options.stats&&(i=`console.time(\`PERF: require @app-component/${n}\`)\n${i}`,i+=`console.timeEnd(\`PERF: require @app-component/${n}\`)\n\n`),r+=i}return r}function processTemplateFrag(e,t,a,r){let s="";if(t.length){const o=t[0];let l=e.resourcePath;const n=o.attrs.src;n&&(l=n),r=r.map(e=>"importNames[]="+e),s="var $app_template$ = "+(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.TEMPLATE,{alone:!!n}),`${l}?uxType=${a}&${r.join(",")}`)}else(0,_utils.logWarn)(e,[{reason:"需要模板片段"}]);return s}function processStyleFrag(e,t,a){let r="var $app_style$ = {};";if(t.length){const s=t[0];let o=e.resourcePath;const l=s.attrs.src,n=s.attrs.lang;l&&(o=l),(0,_utils.print)({style:o}),r="var $app_style$ = "+(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.STYLE,{alone:!!l,lang:n}),`${o}?uxType=${a}`)}return r}function processScriptFrag(e,t,a){let r="";if(t.length){const s=t[0];let o=e.resourcePath;const l=s.attrs.src;l&&(o=l),r="var $app_script$ = "+(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.SCRIPT,{alone:!!l,path:e.resourcePath},a),`${o}?uxType=${a}`)}return r}
//# sourceMappingURL=ux-fragment-utils.js.map

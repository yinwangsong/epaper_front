"use strict";var _webpack=_interopRequireDefault(require("webpack")),_webpackSources=_interopRequireDefault(require("webpack-sources"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const{ConcatSource:ConcatSource,OriginalSource:OriginalSource}=_webpackSources.default,{util:{createHash:createHash}}=_webpack.default,MODULE_TYPE="css/extract",pluginName="css-extract-plugin",REGEXP_NAME=/\[name\]/i,REGEXP_PLACEHOLDERS=/\[name\]/g,DEFAULT_FILENAME="[name].css.json";class CssDependency extends _webpack.default.Dependency{constructor({identifier:e,content:t,media:n,sourceMap:i},s,o){super(),this.identifier=e,this.identifierIndex=o,this.content=t,this.media=n,this.sourceMap=i,this.context=s}getResourceIdentifier(){return`css-module-${this.identifier}-${this.identifierIndex}`}}class CssDependencyTemplate{apply(){}}class CssModule extends _webpack.default.Module{constructor(e){super(MODULE_TYPE,e.context),this.id="",this._identifier=e.identifier,this._identifierIndex=e.identifierIndex,this.content=e.content,this.media=e.media,this.sourceMap=e.sourceMap}size(){return this.content.length}identifier(){return`css ${this._identifier} ${this._identifierIndex}`}readableIdentifier(e){return`css ${e.shorten(this._identifier)}${this._identifierIndex?` (${this._identifierIndex})`:""}`}nameForCondition(){const e=this._identifier.split("!").pop(),t=e.indexOf("?");return t>=0?e.substring(0,t):e}updateCacheModule(e){this.content=e.content,this.media=e.media,this.sourceMap=e.sourceMap}needRebuild(){return!0}build(e,t,n,i,s){this.buildInfo={},this.buildMeta={},s()}updateHash(e){super.updateHash(e),e.update(this.content),e.update(this.media||""),e.update(this.sourceMap?JSON.stringify(this.sourceMap):"")}}class CssModuleFactory{create({dependencies:[e]},t){t(null,new CssModule(e))}}class ExtractCssPlugin{constructor(e={}){if(this.options=Object.assign({filename:DEFAULT_FILENAME,moduleFilename:()=>this.options.filename||DEFAULT_FILENAME,ignoreOrder:!1},e),!this.options.chunkFilename){const{filename:e}=this.options;e.match(REGEXP_PLACEHOLDERS)&&(this.options.chunkFilename=e)}}apply(e){e.hooks.thisCompilation.tap(pluginName,e=>{e.hooks.normalModuleLoader.tap(pluginName,(e,t)=>{const n=t;e[MODULE_TYPE]=e=>{n.addDependency(new CssDependency(e,t.context,0))}}),e.dependencyFactories.set(CssDependency,new CssModuleFactory),e.dependencyTemplates.set(CssDependency,new CssDependencyTemplate),e.mainTemplate.hooks.renderManifest.tap(pluginName,(t,{chunk:n})=>{const i=Array.from(n.modulesIterable).filter(e=>e.type===MODULE_TYPE);i.length>0&&t.push({render:()=>this.renderContentAsset(e,n,i,e.runtimeTemplate.requestShortener),filenameTemplate:({chunk:e})=>this.options.moduleFilename(e),pathOptions:{chunk:n,contentHashType:MODULE_TYPE},identifier:`${pluginName}.${n.id}`,hash:n.contentHash[MODULE_TYPE]})}),e.mainTemplate.hooks.hashForChunk.tap(pluginName,(e,t)=>{const{chunkFilename:n}=this.options;REGEXP_NAME.test(n)&&e.update(JSON.stringify(t.getChunkMaps(!0).name))}),e.hooks.contentHash.tap(pluginName,t=>{const{outputOptions:n}=e,{hashFunction:i,hashDigest:s,hashDigestLength:o}=n,a=createHash(i);for(const e of t.modulesIterable)e.type===MODULE_TYPE&&e.updateHash(a);const{contentHash:r}=t;r[MODULE_TYPE]=a.digest(s).substring(0,o)})})}renderContentAsset(e,t,n,i){let s;const[o]=t.groupsIterable;if("function"==typeof o.getModuleIndex2){const o=new Map(n.map(e=>[e,new Set])),a=Array.from(t.groupsIterable,e=>{const t=n.map(t=>({module:t,index:e.getModuleIndex2(t)})).filter(e=>void 0!==e.index).sort((e,t)=>t.index-e.index).map(e=>e.module);for(let e=0;e<t.length;e++){const n=o.get(t[e]);for(let i=e+1;i<t.length;i++)n.add(t[i])}return t});s=new Set;const r=e=>!s.has(e);for(;s.size<n.length;){let n,d,c=!1;for(const e of a){for(;e.length>0&&s.has(e[e.length-1]);)e.pop();if(0!==e.length){const t=e[e.length-1],i=o.get(t),a=Array.from(i).filter(r);if((!d||d.length>a.length)&&(n=e,d=a),0===a.length){s.add(e.pop()),c=!0;break}}}if(!c){const o=n.pop();this.options.ignoreOrder||e.warnings.push(new Error(`chunk ${t.name||t.id} [${pluginName}]\n`+"Conflicting order between:\n"+` * ${o.readableIdentifier(i)}\n`+`${d.map(e=>` * ${e.readableIdentifier(i)}`).join("\n")}`)),s.add(o)}}}else n.sort((e,t)=>e.index2-t.index2),s=n;const a=new ConcatSource;a.add('{ "list": [\n');let r=0;return s.forEach((e,t,n)=>{a.add(new OriginalSource(e.content,e.readableIdentifier(i))),++r!==n.size&&(a.add(","),a.add("\n"))}),a.add("\n]}"),new ConcatSource(a)}}module.exports=ExtractCssPlugin;
//# sourceMappingURL=extract-css-plugin.js.map

"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.processImportFrag=processImportFrag,exports.processTemplateFrag=processTemplateFrag,exports.processStyleFrag=processStyleFrag,exports.processScriptFrag=processScriptFrag;var _path=_interopRequireDefault(require("path")),_config=_interopRequireDefault(require("@vivo-hap-toolkit/shared-utils/config")),_compilationConfig=require("@vivo-hap-toolkit/shared-utils/compilation-config"),_validator=_interopRequireDefault(require("@vivo-hap-toolkit/compiler/lib/template/validator")),_utils=require("./common/utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const cwd=_config.default.projectPath,loaderPath=__dirname,defaultLoaders={component:_path.default.resolve(loaderPath,"./ux-loader.js"),fragment:_path.default.resolve(loaderPath,"./fragment-loader.js"),template:_path.default.resolve(loaderPath,"./template-loader.js"),style:_path.default.resolve(loaderPath,"./style-loader.js"),script:_path.default.resolve(loaderPath,"./script-loader.js"),module:_path.default.resolve(loaderPath,"./module-loader.js"),babel:(0,_utils.loadBabelModule)("babel-loader"),mainfest:_path.default.resolve(loaderPath,"./manifest-loader.js"),access:_path.default.resolve(loaderPath,"./access-loader.js"),json:_path.default.resolve(loaderPath,"./json-loader.js")},optionBabelrc=process&&process.babelrc;function makeLoaderString(e,t,a){let r;return t=t||{},e===_utils.FRAG_TYPE.IMPORT?(r=[{name:defaultLoaders.component,query:{cwd:cwd,type:_utils.FRAG_TYPE.IMPORT}}],(0,_utils.stringifyLoaders)(r)):e===_utils.FRAG_TYPE.TEMPLATE?(r=[{name:defaultLoaders.json},{name:defaultLoaders.template}],t.alone||r.push({name:defaultLoaders.fragment,query:{index:0,type:_utils.FRAG_TYPE.TEMPLATE}}),(0,_utils.stringifyLoaders)(r)):e===_utils.FRAG_TYPE.STYLE?(r=[{name:defaultLoaders.json},{name:defaultLoaders.style,query:{index:0,type:_utils.FRAG_TYPE.STYLE}}],t.lang&&"css"!==t.lang&&r.push({name:`${t.lang}-loader`}),t.alone||r.push({name:defaultLoaders.fragment,query:{index:0,type:_utils.FRAG_TYPE.STYLE}}),(0,_utils.stringifyLoaders)(r)):e===_utils.FRAG_TYPE.SCRIPT?(r=[{name:defaultLoaders.script},{name:defaultLoaders.module}],a===_utils.ENTRY_TYPE.APP?r.push({name:defaultLoaders.mainfest,query:{path:_path.default.dirname(t.path)}},{name:defaultLoaders.babel,query:{cwd:cwd,cacheDirectory:!0,comments:!1,babelrc:optionBabelrc}}):(r.push({name:defaultLoaders.babel,query:{cwd:cwd,cacheDirectory:!0,plugins:[_path.default.resolve(loaderPath,"./babel-plugin-jsx.js")],comments:!1,babelrc:optionBabelrc}}),(0,_utils.isUXRender)(a)&&r.push({name:defaultLoaders.access})),t.alone||r.push({name:defaultLoaders.fragment,query:{index:0,type:_utils.FRAG_TYPE.SCRIPT}}),(0,_utils.stringifyLoaders)(r)):void 0}function processImportFrag(e,t,a){let r="";if(t.length)for(let s=0;s<t.length;s++){const l=t[s];let o=l.attrs.src,i=l.attrs.name;if(!o)return(0,_utils.logWarn)(e,[{reason:"导入组件需要设置属性 `src` "}]),"";if(!l.isValid)return e.emitError(`导入组件resolve 出错 ${l.err}`),"";o=l.srcPath,i||(i=(0,_utils.getNameByPath)(o)),i=i.toLowerCase(),_validator.default.isReservedTag(i)&&(0,_utils.logWarn)(e,[{reason:"导入组件的属性 `name` 不能使用保留字: "+i}]),a.push(i),(0,_utils.print)({name:i,src:o});let n=(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.IMPORT),`${o}?uxType=${_utils.ENTRY_TYPE.COMP}&name=${i}`);_compilationConfig.options.stats&&(n=`console.time(\`PERF: require @app-component/${i}\`)\n${n}`,n+=`console.timeEnd(\`PERF: require @app-component/${i}\`)\n\n`),r+=n}return r}function processTemplateFrag(e,t,a,r){let s="";if(t.length){const l=t[0];let o=e.resourcePath;const i=l.attrs.src;i&&(o=i),r=r.map(e=>"importNames[]="+e),s="var $app_template$ = "+(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.TEMPLATE,{alone:!!i}),`${o}?uxType=${a}&${r.join(",")}`)}else(0,_utils.logWarn)(e,[{reason:"需要模板片段"}]);return s}function processStyleFrag(e,t,a){let r="var $app_style$ = {};";if(t.length){const s=t[0];let l=e.resourcePath;const o=s.attrs.src,i=s.attrs.lang;o&&(l=o),(0,_utils.print)({style:l}),r="var $app_style$ = "+(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.STYLE,{alone:!!o,lang:i}),`${l}?uxType=${a}`)}return r}function processScriptFrag(e,t,a){let r="";if(t.length){const s=t[0];let l=e.resourcePath;const o=s.attrs.src;o&&(l=o),r="var $app_script$ = "+(0,_utils.makeRequireString)(e,makeLoaderString(_utils.FRAG_TYPE.SCRIPT,{alone:!!o,path:e.resourcePath},a),`${l}?uxType=${a}`)}return r}
//# sourceMappingURL=ux-fragment-utils.js.map

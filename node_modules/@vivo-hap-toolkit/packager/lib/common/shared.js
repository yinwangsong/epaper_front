"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.searchModuleImport=searchModuleImport,exports.updateManifest=updateManifest;var _utils=require("./utils");function frameworkInit(){global.framework={module:{base:"system",ext:"service"},reservedFeatures:[],reservedFeatureExclude:[],supportInCard:[],project:{manifestFilePath:null,featureList:[],module:{usedBaseAll:!1,usedExtAll:!1}}};["contact","webview","notification","media","file","storage","vibrator","calendar","shortcut","network","fetch","geolocation","request","share","clipboard","prompt","device","barcode","bluetooth","sensor","audio","package","volume","record","brightness","battery","image","cipher","sms","wifi","websocketfactory","alarm","mediaquery"].forEach(e=>{global.framework.reservedFeatures.push(`${global.framework.module.base}.${e}`)}),["alipay","push","pay","share","wxpay","stats","account","wxaccount","qqaccount","wbaccount"].forEach(e=>{global.framework.reservedFeatures.push(`${global.framework.module.ext}.${e}`)});["app","model","router"].forEach(e=>{global.framework.reservedFeatureExclude.push(`${global.framework.module.base}.${e}`)});["share","prompt","vibrator","fetch","storage","clipboard","geolocation","network","device","battery","calendar","package","app","router"].forEach(e=>{global.framework.supportInCard.push(`${global.framework.module.base}.${e}`)})}function searchModuleImport(e,r={}){const a=[],o=new RegExp(`['"]@(${global.framework.module.base}|${global.framework.module.ext}).*?['"]`,"g"),t=new RegExp(`['"]@((${global.framework.module.base}|${global.framework.module.ext}).*?)['"]`);return(e.match(o)||[]).forEach(e=>{const o=(e.match(t)||[])[1];o===`@${global.framework.module.base}`?global.framework.project.module.usedBaseAll=!0:o===`@${global.framework.module.ext}`?global.framework.project.module.usedExtAll=!0:-1!==global.framework.reservedFeatures.indexOf(o)?-1===global.framework.project.featureList.indexOf(o)&&global.framework.project.featureList.push(o):r.uxType===_utils.ENTRY_TYPE.CARD&&-1===global.framework.supportInCard.indexOf(o)?a.push({reason:`WARN: 您引入了卡片中未识别的native模块：${o}`}):-1!==global.framework.reservedFeatureExclude.indexOf(o)||a.push({reason:`WARN: 您引入了未识别的native模块：${o}`})}),{fileCont:e,logFeatureList:a}}function checkFeatureInCard(e={}){Object.keys(e).forEach(r=>{e[r].features.every(e=>{-1===global.framework.supportInCard.indexOf(e.name)&&_utils.colorconsole.error(`WARN: manifest.json文件中引入了卡片${r}未识别的features：${e.name}`)})})}function checkFeatures(e,r){const a=global.framework.project;let o;if(r){const e=Object.keys(a.cardFeatureList).find(e=>e.endsWith(r));o=[].concat(a.cardFeatureList[e])}else o=[].concat(a.featureList);e.forEach(e=>{const r=o.indexOf(e.name);-1!==r&&o.splice(r,1)});const t=[];if(o.forEach(e=>{-1!==global.framework.reservedFeatures.indexOf(e)&&t.push(e)}),t.length>0){const a=t.map(function(e){return{name:e}});e.push(...a);const o=t.join(", "),s=r?`卡片 ${r}`:"manifest.json";return _utils.colorconsole.warn(`${s} 中包含了未声明的 features: ${o}\n`),e}}function updateManifest(e,r){if(e.config=e.config||{},e.config.debug=r,e.minPlatformVersion||(e.minPlatformVersion=1020),checkFeatureInCard(e.router.widgets||{}),process.env.BUILD_CARD_ONLY){const r=e.router.widgets;Object.keys(r).forEach(e=>{const a=checkFeatures(r[e].features||[],e);a&&(r[e].features=a)})}else{const r=checkFeatures(e.features||[]);r&&(e.features=r)}return e}frameworkInit();
//# sourceMappingURL=shared.js.map

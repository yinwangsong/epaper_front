"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createPackagesDefinition=createPackagesDefinition,exports.allocateResourceToPackages=allocateResourceToPackages,exports.signZipPkgs=signZipPkgs,exports.DIGEST_ZIP_PATH=void 0;var _path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_jszip=_interopRequireDefault(require("jszip")),_sharedUtils=require("@vivo-hap-toolkit/shared-utils"),_sign=require("../common/sign");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},s=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),s.forEach(function(t){_defineProperty(e,t,n[t])})}return e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const MAIN_PKG_NAME="base",DIGEST_ZIP_PATH="META-INF/CERT";exports.DIGEST_ZIP_PATH=DIGEST_ZIP_PATH;const DEIGEST_HASH_JSON="hash.json",SINGLE_PKG_SIZE=1048576,FULL_PKG_SIZE=4*SINGLE_PKG_SIZE,COMPRESS_OPTS={type:"nodebuffer",compression:"DEFLATE",compressionOptions:{level:9}};function ClassPkgDef(e){Object.assign(this,{fileName:null,standalone:!1,subMatch:null,resourceList:[]},e)}function createFullPackage(){return new ClassPkgDef({fileName:"rpk",standalone:!0})}function createSubPackages(e){let t;t=[];const n=new ClassPkgDef({fileName:MAIN_PKG_NAME+".srpk",standalone:!0});return t.push(n),e.forEach(e=>{const n=new ClassPkgDef({subMatch:new RegExp(`^${e.resource}/.*`,"i"),fileName:e.name+".srpk",standalone:e.standalone||!1});t.push(n)}),t}function createPackagesDefinition(e){const t=createFullPackage();let n;return e&&e.length>0&&(n=createSubPackages(e)),{fullPackage:t,subPackages:n}}function allocateResourceToPackages(e,t,n,s){e.forEach(e=>{const r=_path.default.join(t,e),i=_fs.default.readFileSync(r),a=[e,i,(0,_sign.getBufferDigest)(i)];if(n.addResource(...a),!s)return{fullPackage:n};let o=!0;for(let t=1;t<s.length;t++){const n=s[t];if((n.standalone&&"manifest.json"===e||e.startsWith("i18n"))&&n.addResource(...a),n.subMatch.test(e)){o=!1,n.addResource(...a);break}}if(o){s[0].addResource(...a)}})}function signZipResourcesMeta(e,t,n){const s={};e.forEach(e=>{const t=e.fileBuildPath;s[t]=e.fileContentDigest.toString("hex")});const r=new _jszip.default;return r.file(DEIGEST_HASH_JSON,JSON.stringify({algorithm:"SHA-256",digests:s})),r.generateAsync(COMPRESS_OPTS).then(e=>{const s={name:DEIGEST_HASH_JSON,hash:(0,_sign.getBufferDigest)(e)};return(0,_sign.signZip)(e,[s],t,n)})}function signPackageZip(e,t,n,s,r){const i=e.resourceList,a=new _jszip.default,o=i.map(e=>({name:e.fileBuildPath,hash:e.fileContentDigest}));return new Promise(e=>{r?e():signZipResourcesMeta(i,t,n).then(t=>{a.file(DIGEST_ZIP_PATH,t),o.unshift({name:DIGEST_ZIP_PATH,hash:(0,_sign.getBufferDigest)(t)}),e()})}).then(()=>{const e=_objectSpread({},COMPRESS_OPTS,{comment:s});return i.forEach(e=>{a.file(e.fileBuildPath,e.fileContentBuffer)}),a.generateAsync(e)}).then(e=>(0,_sign.signZip)(e,o,t,n))}function signZipPkgs(e,t,n,s,r,i,a){return signPackageZip(s,t,n,i,a).then(a=>{if(!r)return{rpkBuffer:a};const o=new _jszip.default,c=[];let u=0;const l=r.map(e=>signPackageZip(e,t,n)),f=_objectSpread({},COMPRESS_OPTS,{comment:i});return Promise.all(l).then(t=>{t.forEach((t,n)=>{const s=r[n],i=`${e}.${s.fileName}`,a=t.length;u+=a,_sharedUtils.colorconsole.log(`### App Loader ### '${i}' 大小为 ${Math.ceil(a/1024)} KB`),a>SINGLE_PKG_SIZE&&_sharedUtils.colorconsole.warn(`### App Loader ### 每个分包大小不能大于 ${SINGLE_PKG_SIZE/1024} KB, '${i}' 已超出`),o.file(i,t),c.push({name:i,hash:(0,_sign.getBufferDigest)(t)})}),u>FULL_PKG_SIZE&&_sharedUtils.colorconsole.warn(`### App Loader ### 所有分包总和大小不能大于 ${FULL_PKG_SIZE/1024} KB, 已超出`);const n=`${e}.${s.fileName}`;return o.file(n,a),c.push({name:n,hash:(0,_sign.getBufferDigest)(a)}),o.generateAsync(f)}).then(e=>{return{rpksBuffer:(0,_sign.signZip)(e,c,t,n),rpkBuffer:a}})})}ClassPkgDef.prototype.addResource=function(e,t,n){if(this.resourceList[e])throw new Error(`### App Loader ### ${e} 文件重复添加`);this.resourceList[e]=!0,this.resourceList.push({fileBuildPath:e,fileContentBuffer:t,fileContentDigest:n})};
//# sourceMappingURL=rpks.js.map

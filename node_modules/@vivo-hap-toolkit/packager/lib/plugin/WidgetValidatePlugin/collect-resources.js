"use strict";const parse5=require("parse5"),css=require("css");function getNodes(e,t){const n=[];for(let s=0;s<e.childNodes.length;++s)e.childNodes[s].nodeName===t&&n.push(e.childNodes[s]);return n}const compMap={image:["src"],img:["src"],video:["src"],web:["src"]};function walkNode(e,t){t(e),e.childNodes&&e.childNodes.length&&e.childNodes.forEach(e=>{walkNode(e,t)})}function searchInlineStyle(e){const t="\\burl\\((['\"])?([^\\1]*?)\\1\\)",n=new RegExp(t,"gm"),s=new RegExp(t),o=[];for(n.lastIndex=-1;n.exec(e);){const t=RegExp.leftContext.length,n=RegExp.lastMatch.length+RegExp.leftContext.length,c=e.slice(t,n);if(c.length){const l=c.match(s)[2].trim();o.push({backgroundImage:l,loc:{start:e.indexOf(l,t),end:n+RegExp.leftContext.length}})}}return o}function collectResources(e){const t=parse5.parseFragment(e,{locationInfo:!0,treeAdapter:parse5.treeAdapters.default}),n=getNodes(t,"template")[0],s=getNodes(t,"style"),o=[];return walkNode(n.content,e=>{const t=compMap[e.nodeName];if(t)t.forEach(t=>{const n=e.attrs.find(e=>e.name===t);if(n){const s=e.__location.attrs[t],c=t.length+2;s.col+=c,s.startOffset+=c,o.push({attr:n,loc:s,src:n.value})}});else{const t=(e.attrs||[]).find(e=>"style"===e.name);t&&searchInlineStyle(t.value).forEach(n=>{if(n){const s=Object.assign({},e.__location.attrs.style);s.col+=n.loc.start,s.startOffset+=n.loc.start,s.endOffset-=t.value.length-n.loc.end;const c=t.name.length+2;s.col+=c,s.startOffset+=c,o.push({attr:t,loc:s,src:n.backgroundImage})}})}}),s.forEach(e=>{const t=e.childNodes[0].value;!function(e,t,n){const s=["background","background-image","start-background","star-secondary","star-foreground"],c=n.split("\n");e.filter(Boolean).forEach(e=>{if(-1!==s.indexOf(e.property)){const n=e.value.match(/url\((['"]?)(.*?)\1\)/);if(n){const s={col:c.slice(e.position.start.line-1,e.position.end.line).join("\n").indexOf(n[2],e.position.start.column)+1,line:e.position.start.line+t.startTag.line-1,endLine:e.position.end.line+t.startTag.line-1};s.col+=RegExp.leftContext.length,o.push({loc:s,src:n[2]})}}})}(css.parse(t,{silent:!0}).stylesheet.rules.reduce((e,t)=>("rule"===t.type?e=e.concat(t.declarations):"media"===t.type?t.rules.forEach(t=>{e=e.concat(t.declarations)}):"keyframes"===t.type&&(e=e.concat(...t.keyframes.map(e=>e.declarations))),e),[]),e.__location,t)}),o}function markCollections(e,t,n){n=n||"<unknown>";const s=[];return e.forEach(e=>{const o=e.loc,c=e.src;let l;if(o.startOffset||o.endOffset){const e=t.lastIndexOf("\n",o.startOffset)+1,n=t.indexOf("\n",o.endOffset);l=t.slice(e,n)}else{l=t.split("\n").slice(o.line-1,o.endLine).join("\n")}const a=`${n} at ${o.line}:${o.col}`,r=" ".repeat(o.col-1)+"^"+"-".repeat(c.length-1);s.push([a,l,r].join("\n"))}),s.join("\n")}exports.collectResources=collectResources,exports.markCollections=markCollections;
//# sourceMappingURL=collect-resources.js.map
